<!doctype html>
<html>
  <head>
    <link
      rel="icon"
      type="image/svg+xml"
      sizes="any"
      href="../linkspace.js/mark.svg"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./style.css" />

    <script type="module" src="../web-component/identity.js"></script>
    <script type="module" src="../web-component/lkrctr.js"></script>
    <script type="module" src="../web-component/point-builder.js"></script>
    <script type="module" src="../web-component/runtime-inspect.js"></script>
    <script type="module" src="../web-component/fset.js"></script>
  </head>

  <body>
    <div id="main-with">
      <div id="main">
        <div id="preview"></div>
      </div>
      <div id="aside">
        <div id="steps">
          <details>
            <summary>
              <input
                id="enckey-pass"
                type="password"
                placeholder="Optional Secret"
              />
              <button id="unlock-id">ID</button>
            </summary>
            <div class="fit">
              <elk-identity></elk-identity>
            </div>
          </details>
          <details>
            <summary>
              <input
                id="accept"
                placeholder="Auto Accept"
                spellcheck="false"
                disabled
              />
              <button id="accept-btn">Accept</button>
            </summary>
            <div class="fit">
              <elk-fset></elk-fset>
              <button id="add-alike">Add Alike</button>
            </div>
          </details>
          <details>
            <summary>
              <textarea id="dests" rows="1" spellcheck="false"></textarea>
              <button id="submit">Submit</button>
            </summary>
            <div class="fit">
              <div id="dest-status"></div>
            </div>
          </details>
        </div>
        <details id="advanced">
          <summary>Advanced</summary>
          <fieldset>
            <legend>Point Builder</legend>

            <elk-point-builder linkpoint="false"></elk-point-builder>
          </fieldset>

          <form id="generate-href">
            <fieldset>
              <legend>Generate Link</legend>
              <button type="submit" value="short">Short</button>
              <button type="submit" value="long">Long</button>
              <span style="overflow: hidden"> <a></a></span>
            </fieldset>
          </form>
          <span id="elk-build-info">Loading</span>
        </details>
      </div>
    </div>
  </body>
  <script type="module">
    let $$ = document.querySelector.bind(document);
    const sp = new URLSearchParams(window.location.search);

    import init, {
      b64,
      CONSTS,
      lkr_save,
      lka_encode,
      lka_encode_utf8,
      lka_eval,
      lka_eval2str,
      lk_serialize,
      lk_deserialize,
    } from "../linkspace.js/linkspace.js";
    await init();
    $$("#elk-build-info").innerText = CONSTS.BUILD_INFO;

    let idEl = $$("elk-identity");
    let builderEl = $$("elk-point-builder");
    let fsetEl = $$("elk-fset");
    document.body.addEventListener("elk-error", (e) => {
      $$("status").innerText += e.detail;
    });

    $$("#unlock-id").addEventListener("click", () => idEl.unlock());
    idEl.addEventListener("start-unlock", () => {
      idEl.closest("details").classList.add("bussy");
    });
    idEl.addEventListener("unlock", (e) => {
      $$("#enckey-pass").disabled = true;
      builderEl.setKey(e.detail);
      builderEl.emitBuild("keypoint");
      let step = idEl.closest("details");
      step.classList.add("done");
      step.classList.remove("bussy");
      step.querySelector("summary button").disabled = true;
    });
    idEl.mirrorSecretInput($$("#enckey-pass"));
    builderEl.addEventListener("point", (e) => {
      let point = e.detail;
      $$("#preview").innerHTML = point.toHTML(true);
      fsetEl.test_point(point);
    });
    builderEl.addEventListener("preview-space", (e) => {
      fsetEl.test_values({ ...e.detail, pubkey: idEl.pubkey() });
    });
    fsetEl.init();
    fsetEl.addEventListener("test-result", (e) => {
      $$("#accept").value = e.detail.line || "";
      fsetAccept(e.detail.isMatch);
    });
    let isAccepted = () => fsetEl.closest("details").classList.contains("done");
    $$("#accept-btn").addEventListener("click", () => fsetAccept(true));
    function fsetAccept(isMatch) {
      let step = fsetEl.closest("details");
      step.classList.toggle("done", isMatch);
      $$("#accept-btn").disabled = isMatch;
    }
    $$("#add-alike").addEventListener("click", () => fsetEl.addAlike());

    let dests = [...sp.getAll("dest")];
    let dl = $$("#dests");
    dl.rows = dests.length;
    dl.value = dests.join("\n");
    dl.addEventListener("input", () => {
      $$("#submit").disabled = dl.value.trim() == "";
      dl.closest("details").classList.remove("done");
    });
    function destinations() {
      return dl.value.split("\n").filter((o) => o != "");
    }
    $$("#submit").disabled = dl.value.trim() == "";
    $$("#submit").addEventListener("click", async (e) => {
      e.target.disabled = true;
      let step = e.target.closest("details");
      step.classList.add("bussy");
      try {
        await idEl.unlock();

        if (!fsetEl.closest("details").classList.contains("done")) {
          let msg = lka_eval2str(
            "\\n[domain:str]:[/~?:[group]/#/@/b]\\nSign and submit?",
            { point: fsetEl.point },
          );
          if (!confirm(msg)) return;
        }
        let ok = await submit(fsetEl.point);
        step.classList.toggle("done", ok);
      } catch (e) {
        $$("#status").innerText = e.message;
        $$("#submit").disabled = false;
      } finally {
        step.classList.remove("bussy");
      }
    });

    builderEl.space = sp.get("space");
    builderEl.links = sp.get("links");
    try {
      builderEl.data = lka_eval2str(sp.get("data") || "");
    } catch (e) {
      console.warn(e);
    }
    builderEl.emitBuild("linkpoint");
    function propegate() {
      if (fsetEl.isMatch && sp.get("auto")) {
        submit(fsetEl.point);
      }
    }
    if (sp.get("auto")) {
      builderEl.addEventListener("lk_point", propegate);
      await idEl.unlock();
      builderEl.removeEventListener("lk_point", propegate);
    }

    async function submit(point) {
      $$("#dest-status").innerHTML = "";
      let setStatus = (msg) =>
        $$("#dest-status").insertAdjacentHTML("beforeend", `<li>${msg}</li>`);
      setStatus("submitting " + b64(point.hash));
      $$("#submit").disabled = true;
      let ok = true;
      let dests = destinations();
      let body = lk_serialize(point);
      for (let idx in dests) {
        if (dests[idx].startsWith("#")) continue;
        try {
          let dest = window.location.protocol + "//" + dests[idx];
          setStatus("sending:" + dest);
          let resp = await fetch(dest, { method: "POST", body });
          setStatus("recv reply - " + resp.status);
          if (resp.status != 200)
            throw new Error(`[${resp.status}] ${resp.statusText}`);
          let bytes = new Uint8Array(await resp.arrayBuffer());
          let points = [];
          while (bytes.length != 0) {
            let [point, rest] = lk_deserialize(bytes);
            bytes = rest;
            setStatus(point.toString());
            points.push(point);
          }
          dests[idx] = "#" + dests[idx];
        } catch (e) {
          setStatus("Error: " + e.message);
          ok = false;
        }
      }
      dl.value = dests.join("\n");

      $$("#submit").disabled = ok;
      return ok;
    }

    let ahref = $$("#generate-href a");
    $$("#generate-href").addEventListener("submit", (e) => {
      e.preventDefault();
      let point = builderEl.build_linkpoint();
      let params = new URLSearchParams();
      let long = e.submitter.value == "long";
      if (long) {
        params.append(
          "space",
          lka_eval2str("[domain:str]:[group:str]:[path:str]", { point }),
        );
        if (point.links.length > 0)
          params.append(
            "links",
            lka_eval2str("[/links:[tag:str]\\:[ptr:str]\\/]", { point }),
          );
      } else {
        params.append(
          "space",
          lka_eval2str("[domain:str]:[/~?:[group]/#/@/env/b]:[path:str]", {
            point,
          }),
        );
        if (point.links.length > 0)
          params.append(
            "links",
            lka_eval2str("[/links:[tag:str]\\:[/~?:[group]/#/@/env/b]\\/]", {
              point,
            }),
          );
      }
      if (point.data.length > 0)
        params.append("data", lka_encode_utf8(point.data));
      destinations()
        .map((d) => (d.startsWith("#") ? d.substr(1) : d))
        .forEach((d) => params.append("dest", d));
      ahref.href =
        window.location.origin +
        window.location.pathname +
        "?" +
        params.toString();
      ahref.innerText = ahref.href;
    });
  </script>
</html>
