<!doctype html>
<html lang="en">
  <head>
    <script type="module" src="../web-component/point.js" async></script>
    <script type="module" src="../web-component/point-builder.js" async></script>
    <script type="module" src="../web-component/swipe-list.js" async></script>
    
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta charset="UTF-8" />
    <title>Point-In Point-Out</title>
    </head>
    
    <body>
        
        <details id="builder">
            <summary><button id="ctrl" disabled>Loading JS</button><span id="status">Loading</span></summary>
            <input placeholder="address" id="addr" />
            <input id="pass" placeholder="pass" type="text" name="password" style="text-security:disc; -webkit-text-security:disc;" autocomplete="off">
            <button id="save" >Save</button>
            <lkwc-point-builder></lkwc-point-builder>
            <details><summary>history</summary>
            <swipe-list id="history"></swipe-list>
            <hr>
            </details>
        </details>
        
        <swipe-list id="main"></swipe-list>
    
        <script type="module">
         let $ = document.querySelector.bind(document);
         const sp = new URLSearchParams(window.location.search);
         let isHttps = window.location.protocol == "https:" ? "s" : "";
         $("#addr").value = sp.get("addr") || localStorage.getItem("pipo-addr") || `ws${isHttps}://127.0.0.1:${sp.get("port") || 5021}`;
         $("#pass").value = sp.get("pass") || localStorage.getItem("pipo-pass") || "";
         $("#save").onclick=()=>{
             localStorage.setItem("pipo-addr", $("#addr").value);
             localStorage.setItem("pipo-pass", $("#pass").value);
         }

            import LkWebSocket from "../web-component/LkWebSocket.js";

      
      import init from "../linkspace.js/linkspace.js";
      await init();
      let ws;

     let list = $("#main");
     let history = $("#history");
     list.addEventListener("swipe-left",(ev) =>{
         let swItem = ev.detail.parentElement;
         history.appendChild(swItem);

     });
     list.addEventListener("swipe-right",(ev) =>{
         ws.send(ev.detail.point);
         let swItem = ev.detail.parentElement;
         history.prepend(swItem);
     });
         $("lkwc-point-builder").addEventListener("point",(e) => onPoint(e.detail));

      function onPoint(p) {
        let el = document.createElement("lkwc-point");
        el.point = p;
        list.appendChild(el);
      }
      let ctr = $("#ctrl");

      async function connect() {
          ctr.disabled = true;
          ctr.innerText = "Connecting";
          $("#status").innerText = "";
        try {
            ws = new LkWebSocket($("#addr").value , "ws-pipe+"+ $("#pass").value );
            ws.onpoint = onPoint;
            ws.onerror = (e) => $("#status").innerText = e.message || "Error connecting to " + $("#addr").value;
             ws.onclose = (e) => {
                 if (e.reason) $("#status").innerText = e.reason;
                 ctr.onclick = connect;
                 ctr.innerText="Connect";
             };
             ws.addEventListener("empty", ()=>{
                 ctr.innerText = "Finished sending (Close)";
             });
            ctr.onclick = () => ws.close();
            ctr.innerText = "Close";
        } catch (e) {
            console.error(e);

          $("#status").innerText = e.message;
             if (e.message.indexOf("insecure") != -1) {
            let href = "http" + window.location.toString().slice(5);
            $("#status").innerHTML += ` try downgrading to <a href="${href}">http</a>`;
            }

            ctr.onclick = connect;
            ctr.innerText = "Retry ";
        }
        ctr.disabled = false;
      }
      connect();
    </script>
  </body>
</html>
